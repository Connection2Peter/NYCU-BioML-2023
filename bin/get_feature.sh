#!/bin/bash

# Check input
if [ "$#" -ne 2 ]
then
  echo '# Usage :'
  echo '  Input PSSM and CHK files generated by the same sequence.'
  echo '  ```bash get_feature.sh pssm_file chk_file```'
  exit 1
fi

if [ ! -f $1 ]
then
  echo "# Error :"
  echo "  PSSM file not exist."
  exit 1
fi

if [ ! -f $2 ]
then
  echo "# Error :"
  echo "  CHK file not exist."
  exit 1
fi

# Open work folder and copy
baseDir=$(pwd)
tempDir=$(mktemp -d -p "./")
cp -a template/* $tempDir/
cp $1 $tempDir/input.pssm
cp $2 $tempDir/input.chk
cd $tempDir

# Psipred3
Psipred3-bin/chkparse input.chk > input.mtx
Psipred3-bin/psipred input.mtx Psipred3-data/weights.dat Psipred3-data/weights.dat2 Psipred3-data/weights.dat3 | Psipred3-bin/psipass2 Psipred3-data/weights_p2.dat 1 1.0 1.0 input.ss2 /dev/stdin > /dev/null 2>&1

# RaptorX
RaptorX-bin/run_raptorx-ss8.pl input.pssm > /dev/null 2>&1

# Spider2
python Spider2-bin/pred_pssm.py input.pssm

# Reformat
awk '/^[^#]/{print $4,$5,$6}' input_raptorx.ss3 > refine.ss3
awk '/^[^#]/{print $4,$5,$6,$7,$8,$9,$10,$11}' input_raptorx.ss8 > refine.ss8
awk '/^[^#]/{print $4,$5,$6,$7,$8,$9,$10,$11}' input.spd3 > refine.spd3
awk '/^[^#]/{print $4,$5,$6}' input.ss2 > refine.ss2
paste -d" "  refine.*

# Delete work folder
cd $baseDir
rm -rf $tempDir
